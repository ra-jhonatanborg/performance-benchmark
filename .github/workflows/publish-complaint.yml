name: Publicar ReclamaÃ§Ã£o â€” Reclame AQUI

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Ambiente"
        required: true
        default: "tst"
        type: choice
        options:
          - tst
          - evo
          - prod

      version:
        description: "VersÃ£o do fluxo"
        required: true
        default: "v1"
        type: choice
        options:
          - v1
          - v2

      company:
        description: "Nome da empresa"
        required: true
        default: "Comercial Praia"
        type: string

      complaint_text:
        description: "Texto da reclamaÃ§Ã£o (vazio = usar padrÃ£o)"
        required: false
        type: string

# PermissÃµes necessÃ¡rias para publicar no GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Garante que apenas um deploy de Pages ocorra por vez
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Executar o teste e gerar o relatÃ³rio
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  run-test:
    name: "${{ inputs.environment }} / ${{ inputs.version }} â€” ${{ inputs.company }}"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Habilitar Corepack (Yarn 4)
        run: corepack enable && corepack prepare yarn@4.12.0 --activate

      - name: Instalar dependÃªncias
        run: yarn install --immutable

      - name: Instalar Chromium
        run: yarn playwright install chromium --with-deps

      - name: Publicar reclamaÃ§Ã£o
        continue-on-error: true
        env:
          RA_ENV: ${{ inputs.environment }}
          RA_VERSION: ${{ inputs.version }}
          RA_COMPANY: ${{ inputs.company }}
          RA_TEXT: ${{ inputs.complaint_text }}
          RA_TK: ${{ secrets.RA_TK }}
          RA_RTK: ${{ secrets.RA_RTK }}
          RA_ITK: ${{ secrets.RA_ITK }}
          CI: "true"
        run: yarn playwright test publish-complaint --project=publish-complaint

      # Injeta informaÃ§Ãµes do run no topo do relatÃ³rio HTML
      - name: Adicionar cabeÃ§alho ao relatÃ³rio
        if: always()
        run: |
          INFO="<div style='background:#1a1a2e;color:#fff;padding:12px 20px;font-family:monospace;font-size:13px;display:flex;gap:24px;align-items:center'>\
          <span>ğŸš€ <b>Run #${{ github.run_number }}</b></span>\
          <span>ğŸ“¦ Ambiente: <b>${{ inputs.environment }}</b></span>\
          <span>âš™ï¸ VersÃ£o: <b>${{ inputs.version }}</b></span>\
          <span>ğŸ¢ Empresa: <b>${{ inputs.company }}</b></span>\
          <span>ğŸ• $(date -u '+%d/%m/%Y %H:%M') UTC</span>\
          </div>"
          sed -i "s|<body>|<body>$INFO|" playwright-report/index.html || true

      - name: Upload â€” Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: playwright-report/

      - name: Upload â€” Benchmark JSON
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "benchmark-${{ inputs.environment }}-${{ inputs.version }}-${{ github.run_number }}"
          path: benchmark-results.json
          retention-days: 30

      - name: Resumo no GitHub
        if: always()
        run: |
          echo "## Resultado da PublicaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VersÃ£o | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Empresa | ${{ inputs.company }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          if [ -f benchmark-results.json ]; then
            TOTAL=$(node -e "const d=require('./benchmark-results.json');const l=d[d.length-1];console.log(l.totalFormatted||'-')" 2>/dev/null || echo "-")
            STATUS=$(node -e "const d=require('./benchmark-results.json');const l=d[d.length-1];console.log(l.status||'published')" 2>/dev/null || echo "-")
            echo "| Tempo total | \`$TOTAL\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | \`$STATUS\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [Ver relatÃ³rio completo no GitHub Pages](https://ra-jhonatanborg.github.io/performance-benchmark/)" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Publicar relatÃ³rio no GitHub Pages
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-report:
    name: "Deploy â†’ GitHub Pages"
    needs: run-test
    runs-on: ubuntu-latest
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Publicar no GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
